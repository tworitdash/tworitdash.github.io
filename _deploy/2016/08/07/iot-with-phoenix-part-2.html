<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
	<link rel="manifest" href="/images/site.webmanifest">
	<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
	
	<style>
		@import url('https://fonts.googleapis.com/css?family=Inconsolata');
	</style>
  <title>iot with phoenix part 2</title>
  <meta name="description" content="In part 1, I have demonstrated how to create MVC based user authentication and a plug for the same with Phoenix. Now, in this tutorial we will see how to dis...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://tworitdash.in/2016/08/07/iot-with-phoenix-part-2.html">
  <link rel="alternate" type="application/rss+xml" title="Twor Bot" href="http://tworitdash.in/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Twor Bot</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">

			 <a class="page-link" href="/blog">Blog</a>
			 <a class="page-link" href="/blog/archives">Blog Archives</a>
 	
        
          
          <a class="page-link" href="/about/">About</a>
          
		
          
		
          
		
          
		
          
		
          
		
          
		
          
		
          
		
          
		
          
			
			 <a class="page-link" href="http://resume.tworitdash.in">Resume</a>
			 <a class="page-link" href="http://conferences.tworitdash.in">Conferences</a>

			 <a class="page-link" href="http://blog.tworitdash.in/">Alter Ego</a>
 	
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">iot with phoenix part 2</h1>
    <p class="post-meta">Aug 7, 2016</p>
  </header>

  <article class="post-content">
    <p>In part 1, I have demonstrated how to create MVC based user authentication and a plug for the same with Phoenix. Now, in this tutorial we will see how to display some data using websockets. Websocket connections are consistent. So, for displaying the real time data from the machine, we need to use the channel feature of phoenix, where we can update the data on the page in real time. </p>

<ol>
<li><p>The channel should be user specific. Users can view their own sensor outputs of the machines that they have privately. </p></li>
<li><p>There should be a reverse communication from users to machines. With this, users can be able to switch on or off the machine along with some other things like controlling speed, displaying something on a LCD screen and so on. </p></li>
</ol>

<p>So, let&#39;s create a channel for the users. We will make use of something that will let us make the users&#39; communication private with their machines. </p>
<div class="highlight"><pre><code class="language-" data-lang="">$mix phoenix.gen.channel User
</code></pre></div>
<p>It will create a file called <code>user_channel.ex</code> in <code>web/channles/</code> directory. It contains the following, </p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">    <span class="n">defmodule</span> <span class="no">Iot</span><span class="o">.</span><span class="no">UserChannel</span> <span class="k">do</span>
      <span class="n">use</span> <span class="no">Iot</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:channel</span>

      <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="s2">"user:lobby"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">authorized?</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">do</span>
          <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
        <span class="k">else</span>
          <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="sx">%{reason: "unauthorized"}</span><span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># Channels can be used in a request/response fashion</span>
      <span class="c1"># by sending replies to requests from the client</span>
      <span class="k">def</span> <span class="nf">handle_in</span><span class="p">(</span><span class="s2">"ping"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
        <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">payload</span><span class="p">},</span> <span class="n">socket</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="c1"># It is also common to receive messages from the client and</span>
      <span class="c1"># broadcast to everyone in the current topic (user:lobby).</span>
      <span class="k">def</span> <span class="nf">handle_in</span><span class="p">(</span><span class="s2">"shout"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">broadcast</span> <span class="n">socket</span><span class="p">,</span> <span class="s2">"shout"</span><span class="p">,</span> <span class="n">payload</span>
        <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="c1"># Add authorization logic here as required.</span>
      <span class="n">defp</span> <span class="n">authorized?</span><span class="p">(</span><span class="n">_payload</span><span class="p">)</span> <span class="k">do</span>
        <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>

</code></pre></div>
<p>The join method has a argument <code>user:lobby</code> by default. It is called the <code>topic:subtopic</code> pair. The topic here is <code>user</code> and the subtopic is <code>lobbby</code>. The <code>handle_in</code> method has the first argument as <code>ping</code> or <code>shout</code>. Those are called events. Once a user is joined to the subtopic, the  <code>handle_in</code> methods can show what messages are coming to that subtopic through an event and that <code>handle_in</code> method can also broadcast a message upon arrival through an event. Other subscribers (who have joined to that same subtopic) can get the message through that event.</p>

<p>Making an analogy with our required task, we need to make the subtopic unique for each user. Then we need to create 2 events. One for displaying stuff on a webpage through an event broadcast (broadcasting to a particular event), the other is to broadcast the reverse message from the user to control stuff at the machine. Let&#39;s name those 2 events as <code>sensor_output</code> and <code>control</code>. So, our version of <code>user_channel.ex</code> is given below.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">    <span class="n">defmodule</span> <span class="no">Iot</span><span class="o">.</span><span class="no">UserChannel</span> <span class="k">do</span>
      <span class="n">use</span> <span class="no">Iot</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:channel</span>

      <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="s2">"users:"</span> <span class="o">&lt;&gt;</span> <span class="n">user_token</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">authorized?</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">do</span>
          <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="s2">"Joined To User:</span><span class="si">#{</span><span class="n">user_token</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
        <span class="k">else</span>
          <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="sx">%{reason: "unauthorized"}</span><span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># Channels can be used in a request/response fashion</span>
      <span class="c1"># by sending replies to requests from the client</span>


      <span class="k">def</span> <span class="nf">handle_in</span><span class="p">(</span><span class="s2">"control"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">broadcast</span> <span class="n">socket</span><span class="p">,</span> <span class="s2">"control"</span><span class="p">,</span> <span class="n">payload</span>
        <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">handle_in</span><span class="p">(</span><span class="s2">"sensor_output"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">broadcast</span> <span class="n">socket</span><span class="p">,</span> <span class="s2">"sensor_output"</span><span class="p">,</span> <span class="n">payload</span>
        <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="c1"># Add authorization logic here as required.</span>
      <span class="n">defp</span> <span class="n">authorized?</span><span class="p">(</span><span class="n">_payload</span><span class="p">)</span> <span class="k">do</span>
        <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>

</code></pre></div>
<p>Now, from the above <code>user_channel</code>, it&#39;s clear what the two <code>handle_in</code> methods do on arrival of a new message. They just broadcast it to the respective events. But the join event has the subtopic to be added to the topic <code>users</code>. The subtopic we are using is the <code>user_token</code> that is saved as a string in the <code>Users</code> table whenever a user registers in the application. It has been written in the <code>Password</code> library, refer to the previous blog post. Now, we have to tell our <code>socket</code> file to enable the <code>users</code> topic with a wild card subtopic. Add the following line.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">    <span class="c1">#web/channes/user_socket.ex</span>
    <span class="n">channel</span> <span class="s2">"users:*"</span><span class="p">,</span> <span class="no">Iot</span><span class="o">.</span><span class="no">UserChannel</span>
</code></pre></div>
<p>All set with the background process handlers. Now, let&#39;s move to the front-end. We need a webpage to show all the messages that comes through <code>sensor_output</code> event. Before that, the webpage has to be joined with the <code>users:user_token</code> topic:subtopic. The front-end we will automate with some JS code. Before that, the JS code should have the knowledge of the <code>user_token</code>, otherwise it can&#39;t be able to join the topic. A plain JS code can&#39;t invoke the <code>user_token</code> from the database directly. So, we need to take that <code>user_token</code> from that very template where we want to show the content. The question is, where shall the template render the <code>user_token</code> from ? The answer is pretty simple. From the controller it has been associated with. Voila ! now we have figured out what to do. So, let&#39;s make a model called <code>energy_meter</code>. The model wil be used later. For now, we will use a template only. We are not doing anything with the model now. It&#39;s just for a future use. </p>
<div class="highlight"><pre><code class="language-" data-lang="">$mix phoenix.gen.model EnergyMeter energy_meters name:string pf:integer reading:integer thd:integer load:integer
</code></pre></div>
<p>Then let&#39;s change the template under the folder <code>energy_meter</code> inside the templates folder. The controller is given below.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">    <span class="c1">#web/controller/energy_meter_controller.ex</span>
    <span class="n">defmodule</span> <span class="no">Iot</span><span class="o">.</span><span class="no">EnergyMeterController</span> <span class="k">do</span>
      <span class="n">use</span> <span class="no">Iot</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

      <span class="n">plug</span> <span class="no">Iot</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Authenticate</span>

      <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">current_user</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:current_user</span><span class="p">)</span>
        <span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">"index.html"</span><span class="p">,</span> <span class="ss">current_user: </span><span class="n">current_user</span>
      <span class="k">end</span>
    <span class="k">end</span> 

</code></pre></div>
<p>The template is given below</p>
<div class="highlight"><pre><code class="language-html" data-lang="html">    #web/templates/energy_meter/index.html.eex
    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"em"</span> <span class="na">data-id=</span><span class="s">&lt;%=</span> <span class="err">@</span><span class="na">current_user</span><span class="err">.</span><span class="na">token</span> <span class="err">%</span><span class="nt">&gt;</span>&gt;

    <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"container"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"row"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"span4"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h4&gt;</span>Load<span class="nt">&lt;/h4&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id =</span><span class="err"> </span><span class="s">"load"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>



        <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"span4"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h4&gt;</span>Power Factor<span class="nt">&lt;/h4&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id =</span><span class="err"> </span><span class="s">"pf"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>



        <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"span4"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h4&gt;</span>THD<span class="nt">&lt;/h4&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id =</span><span class="err"> </span><span class="s">"thd"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>



        <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"span4"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h4&gt;</span>Reading<span class="nt">&lt;/h4&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id =</span><span class="err"> </span><span class="s">"reading"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>


    <span class="nt">&lt;/div&gt;</span>




      <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"btn btn-primary"</span> <span class="na">id=</span><span class="s">"on"</span><span class="nt">&gt;</span>ON<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class =</span><span class="err"> </span><span class="s">"btn btn-primary"</span> <span class="na">id=</span><span class="s">"off"</span><span class="nt">&gt;</span>OFF<span class="nt">&lt;/div&gt;</span>
      <span class="err">&lt;</span>%= link("Logout", to: session_path(@conn, :delete), class: "btn btn-success pull-right") %&gt;
    <span class="nt">&lt;/div&gt;</span>

</code></pre></div>
<p>In this way the <code>user_token</code> has been retrieved on to the template. Form the <code>data-id</code> of that division, we can take away that value to our JS files.</p>

<p>Now, the html part is done. Let&#39;s write the JS parts to automate the process. Using jQuery is a better option here as far as ease of writing code is concerned. In the parent directory of the project a bower install will install jQuery libs for us.</p>
<div class="highlight"><pre><code class="language-" data-lang="">$bower install
</code></pre></div>
<p>Now, let&#39;s create a <code>user.js</code> file in <code>web/static/js</code> folder. Before writing something, let&#39;s comment  the default code for joining a <code>topic:subtopic</code>in <code>socket.js</code></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="c1">//let channel = socket.channel("topic:subtopic", {})</span>
    <span class="c1">//channel.join()</span>
      <span class="c1">//.receive("ok", resp =&gt; { console.log("Joined successfully", resp) })</span>
      <span class="c1">//.receive("error", resp =&gt; { console.log("Unable to join", resp) })</span>
</code></pre></div>
<p>Now, the content to write in the <code>user.js</code> file is below. </p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">
    <span class="kr">import</span> <span class="nx">socket</span> <span class="nx">from</span> <span class="s2">"./socket"</span>

    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">ul</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"ul#em"</span><span class="p">)</span>
    <span class="c1">//let message = $("div#message") </span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ul</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">ul</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">topic</span> <span class="o">=</span> <span class="s2">"users:"</span> <span class="o">+</span> <span class="nx">token</span>

        <span class="c1">// Join the topic</span>
        <span class="kd">let</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">channel</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nx">channel</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="s2">"ok"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Joined topic"</span><span class="p">,</span> <span class="nx">topic</span><span class="p">)</span>
          <span class="p">})</span>
          <span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Unable to join topic"</span><span class="p">,</span> <span class="nx">topic</span><span class="p">)</span>
          <span class="p">})</span>


                <span class="nx">$</span><span class="p">(</span><span class="s2">"#on"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                        <span class="nx">channel</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">"control"</span><span class="p">,</span> <span class="p">{</span><span class="na">val</span><span class="p">:</span> <span class="s2">"on"</span><span class="p">});</span>
                <span class="p">})</span>
                <span class="nx">$</span><span class="p">(</span><span class="s2">"#off"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                        <span class="nx">channel</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">"control"</span><span class="p">,</span> <span class="p">{</span><span class="na">val</span><span class="p">:</span> <span class="s2">"off"</span><span class="p">})</span>
                <span class="p">})</span>

                <span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"control"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Recieved: "</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"sensor_output"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#load"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s1">'load'</span><span class="p">]);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#pf"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s1">'pf'</span><span class="p">]);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#thd"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s1">'thd'</span><span class="p">]);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#reading"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s1">'reading'</span><span class="p">]);</span>
                <span class="p">})</span>

      <span class="p">}</span>
    <span class="p">});</span>
</code></pre></div>
<p>This code fetches the value of token from <code>u.data(&quot;id&quot;)</code> from that html template. The topic variable is the concatenation of <code>users</code> and the <code>token</code>. Then the JS client joins the topic. On join, the <code>topic:subtopic</code> is printed on to the console of that web page. Then, there are some event based automation is written. When the button with id <code>on</code> is pressed there at the webpage, the data <code>val: &quot;on&quot;</code> is sent via the <code>control</code> event. And similarly for the <code>off</code> button, the data is sent via <code>control</code> event. Again here, the message is handled and printed on to the console with the following. </p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"control"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Recieved: "</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
    <span class="p">})</span>
</code></pre></div>
<p>So, we can view on the console what the value has been sent from the <code>on</code> and <code>off</code> buttons. Then the next method in the file displays the <code>sensor_output</code> data on to the page. Now, let&#39;s add this file to the app JS file so that it can be added to all the templates.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">   <span class="c1">// web/static/js/app.js</span>
   <span class="kr">import</span> <span class="nx">user</span> <span class="nx">from</span> <span class="s2">"./user"</span>

</code></pre></div>
<p>Now, the button press evens can be tested. Remember, that console messages  <code>on</code> and <code>off</code> can only be seen for a user if he/she is logged in. </p>

<p>For the <code>sensor_output</code> event, let&#39;s broadcast something over that event from the interpreter.</p>
<div class="highlight"><pre><code class="language-" data-lang="">$iex -S mix phoenix.server
</code></pre></div>
<p>Then using the <code>Endpoint.broadcast</code> method we can broadcast a message over a event within a topic. </p>
<div class="highlight"><pre><code class="language-" data-lang="">iex(2)&gt; Iot.Endpoint.broadcast("users:anVhbkBnbWFpbC5jb21qdWxpYTEyMw==", "sensor_output", %{"power_factor" =&gt; 23, "load" =&gt; 1000, "thd" =&gt; 4, "reading" =&gt; 1800})
:ok
iex(3)&gt; Iot.Endpoint.broadcast("users:anVhbkBnbWFpbC5jb21qdWxpYTEyMw==", "sensor_output", %{"power_factor" =&gt; 04, "load" =&gt; 900, "thd" =&gt; 2, "reading" =&gt; 1900})
:ok
</code></pre></div>
<p>As soon as you run, you can see the values updating automatically on the webpage. Similarly, for the <code>control</code> event, just clicking the <code>on</code> and <code>off</code> buttons will do what we want. It will print the message on to the console. A demo screen recording of that is given below. My project name was tworit so I used <code>Tworit.Endpoint</code>. Likewise, here, <code>Iot.Endpoint</code> can be used.</p>

<iframe src="https://player.vimeo.com/video/177943594" width="640" height="400" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>

<p><a href="https://vimeo.com/177943594">phoenix_channels</a> from <a href="https://vimeo.com/user29276136">Tworit</a> on <a href="https://vimeo.com">Vimeo</a>.</p>

<p>In the next part, we will do some python 3.5 asyncio. With the help of that, we can send data from a raspberry pi to the <code>sensor_output</code> event. In addition to that, we can receive the <code>on</code> and <code>off</code> signals from the server to turn on and off our machine. </p>

  </article>

	<div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
				      // Here is an example,
				      // this.page.url = "https://poanchen.github.io/blog/2017/07/27/how-to-add-disqus-to-your-jekyll-site";
		this.page.url = "http://tworitdash.in/2016/08/07/iot-with-phoenix-part-2.html";
				this.page.identifier = "http://tworitdash.in/2016/08/07/iot-with-phoenix-part-2.html";
		};

    // You should be able to get the following lines of code from your Disqus admin.
    // https://disqus.com/admin/universalcode
    		(function() { // DON'T EDIT BELOW THIS LINE
				      var d = document, s = d.createElement('script');
						s.src = 'https://tworitdash-in-blog.disqus.com/embed.js';
							s.setAttribute('data-timestamp', +new Date());
							(d.head || d.body).appendChild(s);
			})();
  </script>
	  <noscript>
				    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>


</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Twor Bot</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Twor Bot</li>
          <li><a href="mailto:tworitdash@gmail.com">tworitdash@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/tworitdash">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">tworitdash</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/tworitdash">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">tworitdash</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">The more Persnickety, The more Hippy.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
